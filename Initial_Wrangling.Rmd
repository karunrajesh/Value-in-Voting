---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Cmd+Shift+Enter*. 

```{r}
library(tidyverse)
library(ggplot2)

```

```{r}
presidential <- read.csv("Data/1976-2016-president.csv")
senate <- read.csv("Data/1976-2018-senate.csv")
context <- read.csv("Data/election-context-2018.csv")
#Get expenditures from web scraping
#Start doing initial analyses with the data
# Analysis 1: Demographics
# Analysis 2: Value in Presidential Voting
# Analysis 3: Value in Senate Voting
# Regression: Predict number of votes for winning candidate given data
# ML Prediction: Put in demographic characteristic and output value?

```

```{r}
#Analysis 1
presidential <- read.csv("Data/1976-2016-president.csv")
senate <- read.csv("Data/1976-2018-senate.csv")
context <- read.csv("Data/election-context-2018.csv")

a <- aggregate(-county ~ state, data = context, mean)
a <- context %>%
  group_by(state) %>%
  select(-county) %>%
  summarise_each(funs(sum))

#Voter Turnout Over Time
senate_turnout <- senate %>%
  group_by(year, state) %>%
  filter(row_number()==1) %>%
  select(year, state, totalvotes)
presidential_turnout <- presidential %>%
  group_by(year, state) %>%
  filter(row_number()==1) %>%
  select(year, state, totalvotes)

#Margins of Victory
margin_pres <- presidential %>%
  group_by(year,state) %>%
  arrange(desc(candidatevotes), .by_group = TRUE)
  filter(row_number() %in% c(1,2)) %>%
  select(year, state, candidate, candidatevotes, totalvotes, party) %>%
  summarize(margin = mean((candidatevotes[1]-candidatevotes[2])/totalvotes), party = party[1])

margin_sen <- senate %>%
  group_by(year,state) %>%
  arrange(desc(candidatevotes), .by_group = TRUE) %>% 
  filter(row_number() %in% c(1,2)) %>%
  select(year, state, candidate, candidatevotes, totalvotes, party) %>%
  summarize(margin = mean((candidatevotes[1]-candidatevotes[2])/totalvotes), party = party[1])

# Switching Parties
parties_pres <- presidential %>%
  group_by(year,state) %>%
  arrange(desc(candidatevotes), .by_group = TRUE) %>%
  filter(row_number() == 1) %>%
  select(year, state, candidate, party)
# Possibly list how many times a state switched over time
parties_sen <- senate %>%
  group_by(year,state) %>%
  arrange(desc(candidatevotes), .by_group = TRUE) %>%
  filter(row_number() == 1) %>%
  select(year, state, candidate, party)

#Get expenditures from web scraping
#Start doing initial analyses with the data
# Analysis 1: Demographics
# Analysis 2: Value in Presidential Voting
# Analysis 3: Value in Senate Voting
# Regression: Predict number of votes for winning candidate given data
# ML Prediction: Put in demographic characteristic and output value?
# Evaluate average voting time and its value
```


```{r}
# Contains the mandatory federal spending per year per agency
budg_all <- read.csv("Data/budget_amount.csv")
budg_all <- data.frame(lapply(budg_all, as.character), stringsAsFactors=FALSE)
colnames(budg_all) = budg_all[2,]
rownames(budg_all) = budg_all[,1]
budg_all = budg_all[-c(1,2,33,34),-1]
cols <- colnames(budg_all)
rows <- rownames(budg_all)
budg = as.data.frame(lapply(budg_all, function(x) as.numeric(gsub(",","",x))))
colnames(budg) <- cols
rownames(budg) <- rows
budg <- budg[,-c(1,2)]
budg_admin <- as.data.frame(sapply(seq(1,dim(budg)[2]-1,by=4),function(i) rowSums(budg[,i:(i+3)], na.rm=TRUE)))

colnames(budg_admin) <- c(as.numeric(colnames(budg[,seq(1,dim(budg)[2]-5,by=4)])) - 1, 2020)

#########################

# Web Scraping, Potentially not needed
library(rvest)
library(tabulizer)
clean_table <- function(df){
  rownames(df) <- df[,1]
  df[,1] <- NULL
  colnames(df) <- df[1,]
  df <- df[-1,]
} 
get_table <- function(url, i){
  h1 <- read_html(url)
  try <- h1 %>% html_nodes("table") %>% .[i]
  budget <- try %>% html_table %>% .[[1]] 
  budget <- clean_table(budget)
  return(budget)
}

budget_2020 <- get_table("https://www.thebalance.com/fy-2020-federal-budget-summary-of-revenue-and-spending-4797868", 1)


blnk <- read_html("https://www.thebalance.com/fy-2019-federal-budget-summary-of-revenue-and-spending-4589082")
hi <- blnk %>% html_nodes("table")


turl <- "https://www.thebalance.com/how-trump-amended-obama-budget-4128986"
h   <- read_html(url)
tab <- h %>% html_nodes("table")
try <- h %>% html_nodes("table") %>% .[1]
budget_comp <- try %>% html_table %>% .[[1]] 

url_2013 <- "https://www.thebalance.com/fy-2013-u-s-federal-budget-and-spending-3306319"
h1 <- read_html(url_2013)
try_2013 <- h1 %>% html_nodes("table") %>% .[2]
budget_2013 <- try_2013 %>% html_table %>% .[[1]] 


budget_2013 <- clean_table(budget_2013)
budget_comp <- clean_table(budget_comp)

# Location of WARN notice pdf file
location <- 'https://www.govinfo.gov/content/pkg/BUDGET-2009-BUD/pdf/BUDGET-2009-BUD-31.pdf'

# Extract the table
out <- extract_tables(location)
df <- out[[4]]
final <- as.data.frame(df)
final <- final[-c(1:5),]
final[,c(5:7)] <- NULL
rows <- as.character(final[,1])
final[,1] <- NULL
colnames(final) <- c("2001", "2008", "2009")
final_f <- mutate_all(final, function(x) as.numeric(as.character(x)))
rownames(final_f) = str_match(rows, "^(.*?)\\.")[,2]

```






```{r}
#Adapted from: https://slate.com/news-and-politics/2016/11/here-are-the-chances-your-vote-matters.html
influence = data.frame(states = c(state.abb), 
                       chance = c(1/7e9,1/100e6,1/40e6, 1/3e9,
                                 1/7e9,1/1e6, 1/40e6, 1/300e6,
                                 1/3e6, 1/60e6, 1/1e9, 1/10e9,
                                 1/1e9, 1/3e9, 1/30e6, 1/1e9,
                                 1/8e9, 1/5e9, 1/5e6, 1/10e9,
                                 1/4e9, 1/3e6, 1/10e6, 1/1e9,
                                 1/1e9, 1/2e9, 1/4e9, 1/2e6,
                                 1/1e6, 1/400e6, 1/3e6, 1/3e9,
                                 1/3e6, 1/4e9, 1/20e6, 1/30e9,
                                 1/40e6, 1/2e6, 1/30e6, 1/100e6,
                                 1/3e9, 1/3e9, 1/1e9, 1/2e9,
                                 1/10e9, 1/10e6, 1/200e6, 1/9e9,
                                 1/2e6, 1/30e9))


va <- influence %>%
  filter(states == "VA")
va_example <- budg_admin * va$chance * 1e6
```


```{r Regression}
# 3 variables: Year, Sector, State
library(caret)
#Setting up Data:
yrs = c(colnames(budg_admin))
sector = rownames(budg_admin)
state = state.abb
y = stack(budg_admin)
y$values = y$values * 1e6
output = data.frame(tcrossprod(y$values,influence$chance))
colnames(output) = state
full_set = stack(output)
full_set <- full_set %>%
  group_by(ind) %>%
  mutate(years = as.numeric(rep(yrs,each = length(sector)))) %>%
  mutate(sectors = rep(sector, length(yrs)))

vars <- c("years")
featurePlot(x = full_set[, vars], 
            y = full_set$values, 
            plot = "scatter",
            type = c("p", "smooth"),
            span = .5,
            layout = c(3, 1))

mod <- lm(values ~ ind + year + sectors, data = full_set)
summary(mod)
residuals(mod)
```


